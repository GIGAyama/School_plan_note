<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
  <style>
    /* 見た目を整えるためのCSSです（変更なし） */
    body { padding: 20px; font-family: sans-serif; }
    .form-group { margin-bottom: 15px; }
    label { font-weight: bold; display: block; margin-bottom: 5px; }
    input[type="number"] { width: 100%; padding: 8px; box-sizing: border-box; }
    .button-bar { margin-top: 20px; text-align: right; }
    #message { margin-top: 15px; font-size: 0.9em; }
    .loading { color: #4a4a4a; }
    .success { color: green; }
    .error { color: red; }
  </style>
  <!-- GoogleのAPIライブラリを読み込み、完了したら 'onGapiLoad' 関数を呼び出します -->
  <script type="text/javascript" src="https://apis.google.com/js/api.js?onload=onGapiLoad"></script>
</head>
<body>
  <h4>行事予定PDFの読み込み</h4>
  <p>PDFが対象としている年度（4月始まり）を入力してください。</p>

  <div class="form-group">
    <label for="year">年度</label>
    <input type="number" id="year" placeholder="例: 2025">
  </div>

  <div class="button-bar">
    <!-- ★★★ 修正点 ★★★ -->
    <!-- 最初はボタンを押せないように 'disabled' を設定し、文言を「初期化中...」に変更します -->
    <button class="action" id="select-file-button" disabled>初期化中...</button>
  </div>
  
  <div id="message"></div>

  <script>
    // --- ここからがダイアログの動作を決めるJavaScriptです ---

    let oauthToken;
    let apiKey;

    /**
     * GoogleのAPIライブラリの準備が完了したときに、一番最初に呼び出される関数です。
     */
    function onGapiLoad() {
      // ★★★ 修正点 ★★★
      // すべての準備が整ったので、ボタンを押せるようにして、文言を元に戻します。
      const button = document.getElementById('select-file-button');
      button.disabled = false;
      button.innerText = 'ファイルを選択';
      
      // ボタンがクリックされたときの動作を、ここで初めて設定します。
      button.addEventListener('click', handleFileSelectClick);
      
      // 画面が開いたときに、今年の年度を自動で入力しておきます。
      document.getElementById('year').value = new Date().getFullYear();
    }

    /**
     * 「ファイルを選択」ボタンがクリックされたときの処理です。
     */
    function handleFileSelectClick() {
      const year = document.getElementById('year').value;
      if (!year) {
        showMessage('年度を入力してください。', 'error');
        return;
      }
      
      const button = document.getElementById('select-file-button');
      button.disabled = true; // 処理中はボタンを一時的に押せなくします
      showMessage('Googleドライブに接続中...', 'loading');

      // サーバー(GAS)に認証情報を要求します。
      google.script.run
        .withSuccessHandler(onAuthInfoReady)
        .withFailureHandler(showError)
        .getPickerAuthInfo();
    }

    /**
     * サーバーから認証情報を無事に受け取った後に呼び出される関数です。
     * @param {object} authInfo - GASから受け取った、トークンとAPIキーが入ったオブジェクト
     */
    function onAuthInfoReady(authInfo) {
      oauthToken = authInfo.token;
      apiKey = authInfo.key;

      // Picker APIライブラリの読み込みを開始します。
      // 読み込みが終わったら、'createPicker' 関数を呼び出します。
      gapi.load('picker', { 'callback': createPicker });
    }

    /**
     * ファイル選択画面を作成して表示する関数です。
     */
    function createPicker() {
      if (oauthToken && apiKey) {
        const view = new google.picker.View(google.picker.ViewId.DOCS);
        view.setMimeTypes("application/pdf");
        
        const picker = new google.picker.PickerBuilder()
            .addView(view)
            .setOAuthToken(oauthToken)
            .setDeveloperKey(apiKey)
            .setCallback(pickerCallback)
            .setOrigin(google.script.host.origin) // GASで動作させるためのおまじない
            .build();
        
        picker.setVisible(true);
      } else {
        showError({ message: '認証情報の取得に失敗しました。' });
      }
    }

    /**
     * ユーザーがファイルを選択した（またはキャンセルした）後に呼び出される関数です。
     */
    function pickerCallback(data) {
      if (data.action === google.picker.Action.PICKED) {
        const fileId = data.docs[0].id;
        const year = document.getElementById('year').value;
        
        showMessage('PDFをAIで分析中です...', 'loading');

        google.script.run
          .withSuccessHandler(onProcessSuccess)
          .withFailureHandler(showError)
          .processEventPdf(fileId, year);

      } else if (data.action === google.picker.Action.CANCEL) {
         showMessage('ファイル選択がキャンセルされました。', 'info');
         document.getElementById('select-file-button').disabled = false;
      }
    }
    
    /**
     * サーバーでのPDF処理が成功したときのコールバックです。
     */
    function onProcessSuccess(resultMessage) {
      showMessage(resultMessage, 'success');
      setTimeout(() => google.script.host.close(), 2000);
    }

    /**
     * エラーが発生したときに呼び出される関数です。
     */
    function showError(error) {
      showMessage('エラー: ' + error.message, 'error');
      document.getElementById('select-file-button').disabled = false;
    }

    /**
     * 画面下部にメッセージを表示するためのヘルパー関数です。
     */
    function showMessage(text, type) {
      const el = document.getElementById('message');
      el.textContent = text;
      el.className = type || '';
    }
  </script>
</body>
</html>
